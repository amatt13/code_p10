<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.1//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_2.dtd'>
<nta>
	<declaration>const int N = 4;
const int S = 3;
const int R = 2;
const int W = 2;
const int SCHEDULE_LENGHT = 360;
const int ORBIT_TIME = 60;
const int MAX_MEMORY = 100;
const int LOW_MEMORY = MAX_MEMORY * 50/100;
const int HIGH_MEMORY = MAX_MEMORY * 75/100;
const int RECEIVE_INDEX = 3;
const int TRANSMIT_INDEX = 2;
const int TASK_SUGGEST_INTERNAL = 3;

const int ZEROES[N] = {0,0,0,0};
const int S_ZEROES[S][N] = {ZEROES, ZEROES, ZEROES};
const int MINUSSES[N] = {-1,-1,-1,-1};
const int S_MINUSSES[S][N] = {MINUSSES, MINUSSES, MINUSSES};
const int ACTIVE_INIT[S] = {-1,-1,-1};

//              index, stations, status
const int STATION_INDEX = 35;
const int STATIONS = 2;
const int STATION_ATTRI = 3;
const int TWINDOW[STATION_INDEX][STATIONS][STATION_ATTRI] = {
{{0, 9, 0}, {0, 1440, 1}},
{{10, 22, 1}, {0, 9999, 0}},
{{23, 97, 0}, {0, 9999, 0}},
{{98, 110, 1}, {0, 9999, 0}},
{{111, 186, 0}, {0, 9999, 0}},
{{187, 198, 1}, {0, 9999, 0}},
{{199, 274, 0}, {0, 9999, 0}},
{{275, 287, 1}, {0, 9999, 0}},
{{288, 362, 0}, {0, 9999, 0}},
{{363, 375, 1}, {0, 9999, 0}},
{{376, 451, 0}, {0, 9999, 0}},
{{452, 463, 1}, {0, 9999, 0}},
{{464, 539, 0}, {0, 9999, 0}},
{{540, 552, 1}, {0, 9999, 0}},
{{553, 627, 0}, {0, 9999, 0}},
{{628, 640, 1}, {0, 9999, 0}},
{{641, 716, 0}, {0, 9999, 0}},
{{717, 728, 1}, {0, 9999, 0}},
{{729, 804, 0}, {0, 9999, 0}},
{{805, 817, 1}, {0, 9999, 0}},
{{818, 892, 0}, {0, 9999, 0}},
{{893, 905, 1}, {0, 9999, 0}},
{{906, 981, 0}, {0, 9999, 0}},
{{982, 993, 1}, {0, 9999, 0}},
{{994, 1069, 0}, {0, 9999, 0}},
{{1070, 1082, 1}, {0, 9999, 0}},
{{1083, 1157, 0}, {0, 9999, 0}},
{{1158, 1170, 1}, {0, 9999, 0}},
{{1171, 1246, 0}, {0, 9999, 0}},
{{1247, 1258, 1}, {0, 9999, 0}},
{{1259, 1334, 0}, {0, 9999, 0}},
{{1335, 1346, 1}, {0, 9999, 0}},
{{1347, 1422, 0}, {0, 9999, 0}},
{{1423, 1435, 1}, {0, 9999, 0}},
{{1436, 1440, 0}, {0, 9999, 0}}};

int data_earth = 0;
int data_storage = 0;
int internal_transfer = 0;
int value = 0;

typedef int[0, N-1] id_t;
typedef int[0, R-1] id_r;
typedef int[0, S-1] id_s;
typedef int[0, W-1] id_w;

clock t_time;

urgent broadcast chan release[S], request[S], grant[S][N], preemt[S], 
		      add_task[S], start[S], check, not_rdy_to_rec[S], go , slew_sat[S], transmit_data[S];

/** Task Description */
typedef struct {
	bool depend_win[W];
	int execution_time;
	int deadline;
	int prio;
	int data_rate;
	bool has_cost;
	int orientation;
} TaskDescription;

/** Satellite Description */
typedef struct {
	int offset;
	int rotation;
	int memory;
	bool can_does[N];
	int suggested_task;
} SatDescription;

/** Window Description */
typedef struct {
	int start_time;
	int end_time;
	int price_rate;
} WindowDescription; 
				      /* 0 = forward, 1 = earth, 2 = backwards*/
                                      /*  w     E  D   P  rate Co   Orien*/
const TaskDescription send_data       = {{1,1}, 20,60, 9, -2, true, 1};
const TaskDescription gather_new_data = {{0,1}, 5,20,  6,  5, true, 0};
const TaskDescription transfer        = {{0,0}, 3,30,  4, -3, true, 2};
const TaskDescription receive         = {{0,0}, 3,30,  5, 3, true, 0};
const TaskDescription jobs[N]         = {send_data, gather_new_data, transfer, receive}; //update RECEIVE_INDEX if receive moves

const SatDescription sat_trans = {3, 0, 0, {0,0,1,1}, -1};
const SatDescription sat_gat = {3, 0, 0, {0,1,1,0}, -1};
const SatDescription sat_sen = {9, 2, 0, {1,0,0,1}, -1};
SatDescription sats[S] = {sat_gat, sat_trans, sat_sen};

const WindowDescription win1 = {0, 60, 13}; 
const WindowDescription win2 = {20, 60, 8};
const WindowDescription wins[W] = {win1, win2};


/** Variables */
id_s RQ;
bool runnable[N] = {0,0,0,0};
bool win_active[W] = {0,0};
clock orbit_time[S];
int orbits[S];
int runs[S][N] = S_ZEROES;
const int prios[N] = {jobs[0].prio, jobs[1].prio, jobs[2].prio, jobs[3].prio};
int priorities[S][N] = {prios, prios, prios};
int active[S] = ACTIVE_INIT;
int queue[S][N] = S_MINUSSES;
int sender = -1;


bool empty(int q[N]){
	int i = 0;
	for (i = 0; i &lt; N; i++){
		if(q[i] != -1){
			return false;
		}
	}
	return true;
}

bool orientation(int sat_id){
	//if (jobs[active[sat_id]].orientation != 0){ // 0 = no specific orientation required
		if (sats[sat_id].rotation != jobs[active[sat_id]].orientation){return false;}
		else {return true;}//}
	//else {return true;}
}

bool validSuggestion(int id) {
	return sats[id].suggested_task != -1;
}



</declaration>
	<template>
		<name>Scheduler</name>
		<parameter>const id_s sat_id</parameter>
		<declaration>int task = 0;
int com = 0;
int is_synced = false;
/** order the queue to highest priority in front */
void orderQueue(){ //OI! Look here
	int i, temp = -1, selected = -1, high = -1, to_check = -1;
	 
	if(queue[sat_id][0] == -1){ return; }
	for (i = 0; i &lt; N; i++){
		if (queue[sat_id][i] != -1) {
			to_check = queue[sat_id][i];
			if (runnable[to_check] == 1) {
				if(priorities[sat_id][to_check] &gt; high){
					selected = i;
					high = priorities[sat_id][to_check];
	}}}}
	if (selected != -1) {
		temp = queue[sat_id][selected];
		queue[sat_id][selected] = queue[sat_id][0];
		queue[sat_id][0] = temp;
	}

}
/** Add task to back of queue */
void enqueue(int _task){
	int i = 0;
	if (queue[sat_id][N-1] == -1){
	for (i = 0; i &lt; N; i++){
		if (queue[sat_id][i] == -1){
			queue[sat_id][i] = _task; 
			i = N;
		} else if (queue[sat_id][i] == _task) {
			return;
		}}
	}
	orderQueue();
	
}
/** Amount of queued tasks */
int len(){ 
	int i;
	for (i = 0; i &lt; N; i++){
		if(queue[sat_id][i] == -1) {
			return i; 
		}
	}
	return N;
}
/** Update the queue after running the first one */
void dequeue(){
	int i = 0, k = len();
        while (i &lt; k) {
        	queue[sat_id][i] = queue[sat_id][i + 1];
                i++;
        }
        queue[sat_id][i] = -1;
	orderQueue();
}

void set_com(){
    if (sat_id == S-1) com = sat_id;
    else com = sat_id + 1;
}

bool hasSpace(){
	return sats[sat_id].memory + transfer.data_rate * transfer.execution_time &lt;= MAX_MEMORY;
}

int orientationProgress(){
	if (sats[sat_id].rotation == transfer.orientation &amp;&amp; sats[com].rotation == receive.orientation){
		return 0;
	}
	else if (sats[sat_id].rotation == transfer.orientation &amp;&amp; sats[com].rotation != receive.orientation){
		return 1;
	}
	else if (sats[sat_id].rotation != transfer.orientation &amp;&amp; sats[com].rotation == receive.orientation){
		return 2;
	}
	else{   
		return 3;
	}
}
bool rdyToTrans(){
	if (sats[com].rotation == receive.orientation &amp;&amp; sats[sat_id].rotation == transfer.orientation) return true;
	else return false;
}


bool lowerPriority() {
	return priorities[sat_id][queue[sat_id][0] ] &lt;= priorities[sat_id][active[sat_id]];
}


int front() {
	return queue[sat_id][0];
}

bool notInternalCom() {
	return (task != RECEIVE_INDEX &amp;&amp; task != TRANSMIT_INDEX);
}






















</declaration>
		<location id="id0" x="120" y="-136">
			<committed/>
		</location>
		<location id="id1" x="376" y="-264">
			<committed/>
		</location>
		<location id="id2" x="432" y="48">
			<committed/>
		</location>
		<location id="id3" x="432" y="-40">
			<committed/>
		</location>
		<location id="id4" x="576" y="-40">
		</location>
		<location id="id5" x="576" y="128">
		</location>
		<location id="id6" x="336" y="-208">
			<committed/>
		</location>
		<location id="id7" x="-80" y="-224">
			<committed/>
		</location>
		<location id="id8" x="-32" y="368">
			<committed/>
		</location>
		<location id="id9" x="56" y="368">
			<committed/>
		</location>
		<location id="id10" x="-232" y="128">
			<committed/>
		</location>
		<location id="id11" x="-232" y="64">
			<committed/>
		</location>
		<location id="id12" x="120" y="32">
			<committed/>
		</location>
		<location id="id13" x="248" y="368">
			<name x="224" y="384">Preempt</name>
			<committed/>
		</location>
		<location id="id14" x="240" y="-136">
			<name x="264" y="-152">Release</name>
			<committed/>
		</location>
		<location id="id15" x="238" y="127">
			<name x="256" y="104">Occupied</name>
		</location>
		<location id="id16" x="-82" y="127">
			<committed/>
		</location>
		<location id="id17" x="-83" y="-134">
			<name x="-72" y="-128">Start</name>
		</location>
		<init ref="id7"/>
		<transition>
			<source ref="id14"/>
			<target ref="id0"/>
			<label kind="guard" x="80" y="-176">active[com] != RECEIVE_INDEX</label>
			<nail x="224" y="-160"/>
			<nail x="144" y="-160"/>
		</transition>
		<transition>
			<source ref="id14"/>
			<target ref="id0"/>
			<label kind="guard" x="120" y="-128">active[com] == 
RECEIVE_INDEX</label>
			<label kind="synchronisation" x="128" y="-104">release[com]!</label>
		</transition>
		<transition>
			<source ref="id1"/>
			<target ref="id17"/>
			<label kind="synchronisation" x="-40" y="-280">release[sat_id]!</label>
			<label kind="assignment" x="-40" y="-264">active[sat_id] = -1</label>
			<nail x="-48" y="-264"/>
		</transition>
		<transition>
			<source ref="id4"/>
			<target ref="id14"/>
			<label kind="synchronisation" x="416" y="-128">release[sat_id]?</label>
			<nail x="568" y="-128"/>
		</transition>
		<transition>
			<source ref="id5"/>
			<target ref="id14"/>
			<label kind="synchronisation" x="416" y="-152">release[sat_id]?</label>
			<nail x="584" y="120"/>
			<nail x="680" y="120"/>
			<nail x="680" y="-136"/>
			<nail x="584" y="-136"/>
			<nail x="584" y="-144"/>
			<nail x="568" y="-144"/>
			<nail x="568" y="-136"/>
		</transition>
		<transition>
			<source ref="id5"/>
			<target ref="id1"/>
			<label kind="guard" x="408" y="-288">task == TRANSMIT_INDEX</label>
			<label kind="synchronisation" x="416" y="-264">not_rdy_to_rec[com]?</label>
			<nail x="688" y="128"/>
			<nail x="688" y="96"/>
			<nail x="688" y="-264"/>
		</transition>
		<transition>
			<source ref="id2"/>
			<target ref="id15"/>
			<label kind="synchronisation" x="272" y="32">transmit_data[com]!</label>
			<nail x="272" y="48"/>
		</transition>
		<transition>
			<source ref="id3"/>
			<target ref="id15"/>
			<label kind="synchronisation" x="296" y="-8">request[com]!</label>
			<nail x="272" y="8"/>
		</transition>
		<transition>
			<source ref="id5"/>
			<target ref="id2"/>
			<label kind="guard" x="464" y="32">rdyToTrans()</label>
			<label kind="synchronisation" x="448" y="48">request[sat_id]!</label>
			<nail x="560" y="48"/>
		</transition>
		<transition>
			<source ref="id4"/>
			<target ref="id3"/>
			<label kind="guard" x="456" y="-56">rdyToTrans()</label>
			<label kind="synchronisation" x="448" y="-40">request[sat_id]!</label>
		</transition>
		<transition>
			<source ref="id5"/>
			<target ref="id4"/>
			<label kind="guard" x="528" y="-16">orientation(sat_id) &amp;&amp; 
!rdyToTrans()</label>
			<label kind="synchronisation" x="528" y="8">transmit_data[com]!</label>
		</transition>
		<transition>
			<source ref="id15"/>
			<target ref="id5"/>
			<label kind="guard" x="344" y="80">task == TRANSMIT_INDEX
&amp;&amp; !is_synced &amp;&amp;
active[com] == -1</label>
			<label kind="synchronisation" x="392" y="144">go!</label>
			<label kind="assignment" x="344" y="128">is_synced = true</label>
		</transition>
		<transition>
			<source ref="id4"/>
			<target ref="id1"/>
			<label kind="synchronisation" x="416" y="-232">not_rdy_to_rec[com]?</label>
			<nail x="576" y="-232"/>
			<nail x="376" y="-232"/>
		</transition>
		<transition>
			<source ref="id6"/>
			<target ref="id15"/>
			<label kind="synchronisation" x="288" y="-80">request[sat_id]!</label>
			<nail x="336" y="-32"/>
			<nail x="248" y="0"/>
		</transition>
		<transition>
			<source ref="id17"/>
			<target ref="id6"/>
			<label kind="guard" x="144" y="-240">hasSpace()</label>
			<label kind="synchronisation" x="112" y="-224">transmit_data[sat_id]?</label>
			<label kind="assignment" x="88" y="-208">task = RECEIVE_INDEX,
active[sat_id] = RECEIVE_INDEX</label>
			<nail x="0" y="-208"/>
		</transition>
		<transition>
			<source ref="id7"/>
			<target ref="id17"/>
			<label kind="assignment" x="-152" y="-192">set_com()</label>
		</transition>
		<transition>
			<source ref="id8"/>
			<target ref="id15"/>
			<label kind="guard" x="-8" y="176">!runnable[task]</label>
			<label kind="synchronisation" x="-24" y="192">not_rdy_to_rec[sat_id]!</label>
			<nail x="-32" y="192"/>
			<nail x="112" y="192"/>
		</transition>
		<transition>
			<source ref="id8"/>
			<target ref="id16"/>
			<label kind="guard" x="-187" y="229">runnable[task]</label>
			<label kind="synchronisation" x="-192" y="248">preemt[sat_id]!</label>
			<label kind="assignment" x="-240" y="264">active[sat_id] = front()</label>
			<nail x="-80" y="368"/>
		</transition>
		<transition>
			<source ref="id9"/>
			<target ref="id8"/>
			<label kind="synchronisation" x="-8" y="376">check?</label>
		</transition>
		<transition>
			<source ref="id10"/>
			<target ref="id16"/>
			<label kind="synchronisation" x="-184" y="128">check?</label>
			<label kind="assignment" x="-248" y="144">active[sat_id] = front()</label>
		</transition>
		<transition>
			<source ref="id11"/>
			<target ref="id10"/>
			<label kind="synchronisation" x="-224" y="80">check!</label>
		</transition>
		<transition>
			<source ref="id16"/>
			<target ref="id17"/>
			<label kind="guard" x="-176" y="-48">queue[sat_id][0] == -1 ||
!runnable[queue[sat_id][0]]</label>
			<label kind="assignment" x="-176" y="-16">active[sat_id] = -1</label>
		</transition>
		<transition>
			<source ref="id12"/>
			<target ref="id16"/>
			<label kind="synchronisation" x="-40" y="32">check?</label>
			<label kind="assignment" x="-48" y="0">orderQueue(),
active[sat_id] = front()</label>
			<nail x="-48" y="32"/>
			<nail x="-48" y="80"/>
		</transition>
		<transition>
			<source ref="id13"/>
			<target ref="id9"/>
			<label kind="guard" x="96" y="352">!lowerPriority()</label>
			<label kind="synchronisation" x="112" y="368">check!</label>
		</transition>
		<transition>
			<source ref="id0"/>
			<target ref="id17"/>
			<label kind="guard" x="-48" y="-152">empty(queue[sat_id])</label>
			<label kind="assignment" x="-32" y="-136">active[sat_id] = -1</label>
		</transition>
		<transition>
			<source ref="id13"/>
			<target ref="id15"/>
			<label kind="guard" x="288" y="232">lowerPriority()</label>
			<label kind="synchronisation" x="288" y="248">not_rdy_to_rec[sat_id]!</label>
			<nail x="280" y="336"/>
			<nail x="280" y="224"/>
		</transition>
		<transition>
			<source ref="id0"/>
			<target ref="id12"/>
			<label kind="guard" x="16" y="-56">!empty(queue[sat_id])</label>
			<label kind="synchronisation" x="64" y="-40">check!</label>
		</transition>
		<transition>
			<source ref="id15"/>
			<target ref="id13"/>
			<label kind="guard" x="72" y="224">validSuggestion(sat_id) &amp;&amp;
notInternalCom()</label>
			<label kind="synchronisation" x="80" y="256">add_task[sat_id]?</label>
			<label kind="assignment" x="24" y="272">task = sats[sat_id].suggested_task,
enqueue(task),
RQ = sat_id</label>
			<nail x="208" y="216"/>
			<nail x="208" y="336"/>
		</transition>
		<transition>
			<source ref="id15"/>
			<target ref="id14"/>
			<label kind="synchronisation" x="184" y="-32">release[sat_id]?</label>
			<label kind="assignment" x="176" y="-64">orderQueue(),
RQ = sat_id</label>
		</transition>
		<transition>
			<source ref="id16"/>
			<target ref="id15"/>
			<label kind="guard" x="-8" y="96">queue[sat_id][0] != -1 &amp;&amp; 
runnable[queue[sat_id][0]]</label>
			<label kind="synchronisation" x="-8" y="128">request[sat_id]!</label>
			<label kind="assignment" x="-8" y="144">dequeue(), is_synced = false</label>
		</transition>
		<transition>
			<source ref="id17"/>
			<target ref="id11"/>
			<label kind="synchronisation" x="-328" y="-104">add_task[sat_id]?</label>
			<label kind="assignment" x="-336" y="-88">task = sats[sat_id].suggested_task,
enqueue(task)</label>
			<nail x="-232" y="-136"/>
		</transition>
	</template>
	<template>
		<name>Processor</name>
		<parameter>const id_s sat_id</parameter>
		<declaration>clock run_time[N], exe_time;
int time_used[N] = ZEROES;
int task = 0;
int price;
int expenses;
int rec = 0;
clock idle, wait, work;

void resetPriority() {
	int i;
    priorities[sat_id][task] = jobs[task].prio;
    for(i = 0; i &lt; N; i++){
        if (priorities[sat_id][i] == 0){
            priorities[sat_id][i] = jobs[i].prio;
        }
    }
}


void boostPriority(){
	priorities[sat_id][task] = jobs[active[sat_id]].prio + 1;
}

void calc_cost(){
// TODO: Håndter overlappende vinduer
	int i = 0;
    price = 9999;
	for (i = 0; i &lt; W; i++){
	    if(jobs[task].depend_win[i] == 1 &amp;&amp; win_active[i]){
            if (price &gt;= wins[i].price_rate * jobs[task].execution_time){
                price = wins[i].price_rate * jobs[task].execution_time; //choose cheapest
            }
	    }
	}
    if (price == 9999){
        price = 0;
    }
}

void statistics(int mult, int value){
	if (value &lt; 0){
		data_earth += value*-1;
	}
	else{
		data_storage += value;
	}
}

void update_storage(int mult){
	//TODO introduce finer grunulairy (in case of preemption)
	value = (jobs[task].execution_time * jobs[task].data_rate * mult)/2;
	sats[sat_id].memory += value;
	if (sats[sat_id].memory &gt; MAX_MEMORY) {
		value = (value - (MAX_MEMORY - sats[sat_id].memory));
		sats[sat_id].memory = MAX_MEMORY;	
	} else if (sats[sat_id].memory &lt; 0) {
		value = (value - sats[sat_id].memory);
		sats[sat_id].memory = 0;
	}
	if (task !=  RECEIVE_INDEX &amp;&amp; task != TRANSMIT_INDEX){
		statistics(mult, value);
	}
	else if (value &gt; 0) {
		internal_transfer += value;
	}
}

void reportDone() {
	runs[sat_id][task] ++;
	update_storage(2);
	expenses = expenses + price;
}

void updateProgress(int time) {
	time_used[task] += time;
}

void resetProgress() {
	time_used[task] = 0;
}

void startNew(){
	task = active[sat_id];
	exe_time = 0;
	run_time[task] = 0;
	calc_cost();
}

bool isInternalCom(){
	if (task == RECEIVE_INDEX|| task == TRANSMIT_INDEX) return true;
	else return false;
}


bool activeTrans() {
	return active[sat_id] == TRANSMIT_INDEX;
}

int getETime() {			      
	return jobs[task].execution_time;
}

int getDeadline() {
	return jobs[task].deadline;
}

int getExeTime() {
	return jobs[task].execution_time;
}

bool activeIsTrans() {
	return active[sat_id] == TRANSMIT_INDEX;
}


void preemt_task() {
	boostPriority();
	updateProgress(jobs[task].execution_time/2);
	task = active[sat_id];
	run_time[task] = 0;
}













</declaration>
		<location id="id18" x="32" y="240">
			<committed/>
		</location>
		<location id="id19" x="32" y="-152">
			<committed/>
		</location>
		<location id="id20" x="-224" y="-80">
			<name x="-248" y="-112">Aborted</name>
			<committed/>
		</location>
		<location id="id21" x="32" y="-80">
			<name x="40" y="-104">Waiting</name>
			<label kind="invariant" x="22" y="-63">idle '== 0 &amp;&amp;
work '== 0 &amp;&amp;
wait '== 1</label>
		</location>
		<location id="id22" x="-408" y="-80">
			<name x="-448" y="-104">End</name>
			<committed/>
		</location>
		<location id="id23" x="32" y="96">
			<name x="48" y="88">Slewing</name>
			<label kind="invariant" x="22" y="113">idle '== 0 &amp;&amp;
work '== 1 &amp;&amp;
wait '== 0</label>
		</location>
		<location id="id24" x="-224" y="96">
			<name x="-312" y="72">Occupied</name>
			<label kind="invariant" x="-392" y="104">run_time[task]  &lt;= 
getDeadline() &amp;&amp;
exe_time + time_used[task]  &lt;= 
getExeTime() &amp;&amp;
idle '== 0 &amp;&amp;
work '== 1 &amp;&amp;
wait '== 0</label>
		</location>
		<location id="id25" x="-224" y="240">
			<name x="-240" y="256">Block</name>
			<committed/>
		</location>
		<location id="id26" x="-616" y="96">
			<name x="-608" y="72">Free</name>
			<label kind="invariant" x="-637" y="110">idle '== 1 &amp;&amp;
work '== 0 &amp;&amp;
wait '== 0</label>
		</location>
		<init ref="id26"/>
		<transition>
			<source ref="id21"/>
			<target ref="id18"/>
			<label kind="synchronisation" x="64" y="40">preemt[sat_id]?</label>
			<nail x="112" y="-48"/>
			<nail x="112" y="104"/>
			<nail x="112" y="240"/>
		</transition>
		<transition>
			<source ref="id18"/>
			<target ref="id25"/>
			<label kind="assignment" x="-104" y="240">preemt_task()</label>
		</transition>
		<transition>
			<source ref="id23"/>
			<target ref="id18"/>
			<label kind="synchronisation" x="-24" y="200">preemt[sat_id]?</label>
		</transition>
		<transition>
			<source ref="id19"/>
			<target ref="id22"/>
			<label kind="synchronisation" x="-264" y="-152">release[sat_id]!</label>
			<nail x="-408" y="-152"/>
		</transition>
		<transition>
			<source ref="id20"/>
			<target ref="id22"/>
		</transition>
		<transition>
			<source ref="id24"/>
			<target ref="id20"/>
			<label kind="synchronisation" x="-280" y="-48">release[sat_id]?</label>
		</transition>
		<transition>
			<source ref="id23"/>
			<target ref="id20"/>
			<label kind="synchronisation" x="-96" y="32">release[sat_id]?</label>
			<nail x="-88" y="16"/>
			<nail x="-80" y="8"/>
			<nail x="-96" y="-8"/>
			<nail x="-104" y="0"/>
		</transition>
		<transition>
			<source ref="id21"/>
			<target ref="id20"/>
			<label kind="synchronisation" x="-152" y="-96">release[sat_id]?</label>
		</transition>
		<transition>
			<source ref="id21"/>
			<target ref="id19"/>
			<label kind="guard" x="-104" y="-128">run_time[task] &gt;= getDeadline()</label>
		</transition>
		<transition>
			<source ref="id26"/>
			<target ref="id21"/>
			<label kind="guard" x="-624" y="-200">activeIsTrans() &amp;&amp; 
orientation(sat_id)</label>
			<label kind="synchronisation" x="-624" y="-168">request[sat_id]?</label>
			<label kind="assignment" x="-624" y="-152">startNew()</label>
			<nail x="-640" y="96"/>
			<nail x="-640" y="-168"/>
			<nail x="128" y="-168"/>
			<nail x="128" y="-80"/>
		</transition>
		<transition>
			<source ref="id21"/>
			<target ref="id24"/>
			<label kind="synchronisation" x="-88" y="-48">request[sat_id]?</label>
			<label kind="assignment" x="-88" y="-32">exe_time = 0,
calc_cost()</label>
		</transition>
		<transition>
			<source ref="id23"/>
			<target ref="id21"/>
			<label kind="guard" x="-48" y="-8">isInternalCom() &amp;&amp;
orientation(sat_id)</label>
			<label kind="synchronisation" x="-48" y="16">slew_sat[sat_id]?</label>
		</transition>
		<transition>
			<source ref="id22"/>
			<target ref="id26"/>
			<label kind="synchronisation" x="-608" y="-96">release[sat_id]!</label>
			<label kind="assignment" x="-608" y="-80">resetPriority(),
resetProgress()</label>
			<nail x="-616" y="-80"/>
		</transition>
		<transition>
			<source ref="id24"/>
			<target ref="id22"/>
			<label kind="guard" x="-544" y="-56">run_time[task] &gt;= 
getDeadline() &amp;&amp; 
exe_time + time_used[task]  &lt; 
getExeTime()</label>
			<label kind="assignment" x="-544" y="0">update_storage(1)</label>
			<nail x="-408" y="80"/>
		</transition>
		<transition>
			<source ref="id23"/>
			<target ref="id24"/>
			<label kind="guard" x="-104" y="120">!isInternalCom() &amp;&amp;
orientation(sat_id)</label>
			<label kind="synchronisation" x="-104" y="144">slew_sat[sat_id]?</label>
			<label kind="assignment" x="-104" y="160">exe_time = 0</label>
			<nail x="-104" y="128"/>
		</transition>
		<transition>
			<source ref="id24"/>
			<target ref="id23"/>
			<label kind="guard" x="-168" y="56">!orientation(sat_id)</label>
			<label kind="synchronisation" x="-168" y="72">slew_sat[sat_id]!</label>
			<nail x="-104" y="72"/>
		</transition>
		<transition>
			<source ref="id24"/>
			<target ref="id22"/>
			<label kind="guard" x="-392" y="0">exe_time + time_used[task] 
==  getETime()</label>
			<label kind="assignment" x="-392" y="24">reportDone()</label>
			<label kind="comments" x="-408" y="38">Unblock</label>
			<nail x="-328" y="0"/>
		</transition>
		<transition>
			<source ref="id25"/>
			<target ref="id24"/>
			<label kind="assignment" x="-176" y="184">exe_time = 0,
calc_cost()</label>
			<nail x="-176" y="224"/>
			<nail x="-176" y="120"/>
		</transition>
		<transition>
			<source ref="id24"/>
			<target ref="id25"/>
			<label kind="synchronisation" x="-336" y="176">request[sat_id]?</label>
			<label kind="assignment" x="-328" y="192">preemt_task()</label>
		</transition>
		<transition>
			<source ref="id26"/>
			<target ref="id24"/>
			<label kind="guard" x="-552" y="48">!activeTrans() ||
(activeTrans() &amp;&amp;
!orientation(sat_id))</label>
			<label kind="synchronisation" x="-552" y="96">request[sat_id]?</label>
			<label kind="assignment" x="-552" y="112">startNew(),
calc_cost()</label>
			<nail x="-472" y="96"/>
		</transition>
	</template>
	<template>
		<name>OrbitTimer</name>
		<parameter>const id_s sat_id</parameter>
		<location id="id27" x="-208" y="-696">
			<name x="-264" y="-704">Offset</name>
			<committed/>
		</location>
		<location id="id28" x="-208" y="-800">
			<name x="-256" y="-808">Start</name>
			<label kind="invariant" x="-192" y="-816">orbit_time[sat_id] 
&lt;= sats[sat_id].offset</label>
		</location>
		<location id="id29" x="-208" y="-616">
			<name x="-280" y="-624">Revolve</name>
			<label kind="invariant" x="-192" y="-624">orbit_time[sat_id] &lt;= ORBIT_TIME</label>
		</location>
		<init ref="id28"/>
		<transition>
			<source ref="id27"/>
			<target ref="id29"/>
			<label kind="synchronisation" x="-208" y="-664">start[sat_id]!</label>
		</transition>
		<transition>
			<source ref="id28"/>
			<target ref="id27"/>
			<label kind="guard" x="-208" y="-776">orbit_time[sat_id] &gt;= 
sats[sat_id].offset</label>
			<label kind="assignment" x="-208" y="-744">orbit_time[sat_id] = 0</label>
		</transition>
		<transition>
			<source ref="id29"/>
			<target ref="id29"/>
			<label kind="guard" x="-296" y="-552">orbit_time[sat_id] &gt;= ORBIT_TIME</label>
			<label kind="assignment" x="-264" y="-536">orbit_time[sat_id] = 0,
orbits[sat_id] ++</label>
			<nail x="-144" y="-552"/>
			<nail x="-264" y="-552"/>
		</transition>
	</template>
	<template>
		<name>Satellite</name>
		<parameter>const id_s sat_id</parameter>
		<declaration>clock loc_time, slew_time;
bool is_queued[N] = {0,0,0,0};
int selected = -1;

/** Change satellite orientation */
void turn_satellite(){
	if (sats[sat_id].rotation &lt; jobs[active[sat_id]].orientation){sats[sat_id].rotation ++;}
	else if (sats[sat_id].rotation &gt; jobs[active[sat_id]].orientation){sats[sat_id].rotation --;}
}

/** Suggest a new task to execute */
void suggest_task(){
	int i, j, k, count = 0, high = -1; bool cans[N] = {0,0,0,0};
	selected = -1;

	for (i = 0; i &lt; N; i++){
		if (sats[sat_id].can_does[i]) { 
			cans[i] = true; }}

	for (i = 0; i &lt; N - 1; i++) {
		if (cans[i]) {
			if (sats[sat_id].memory &lt;= LOW_MEMORY ) {
				if (jobs[i].data_rate &gt; 0) {
					if (priorities[sat_id][i]*2 &lt;= 100) {
						priorities[sat_id][i] = priorities[sat_id][i] * 2; 
					}
					else {
						priorities[sat_id][i] = 100;
					}
				}
				else if (jobs[i].data_rate &lt; 0) {
					priorities[sat_id][i] = 0;
				}
			}
			else if (sats[sat_id].memory &gt;= HIGH_MEMORY) {
				if (jobs[i].data_rate &lt; 0) {
					if (priorities[sat_id][i]*2 &lt;= 100) {
						priorities[sat_id][i] = priorities[sat_id][i] * 2; 
					}
					else {
						priorities[sat_id][i] = 100;
					}
				}
				else if (jobs[i].data_rate &gt; 0) {
					priorities[sat_id][i] = 0;
				} 
			}
		}
	}

	//TODO make logic for handeling ties
	for (i = 0; i &lt; N - 1; i++){
		if (cans[i] &amp;&amp; priorities[sat_id][i] &gt; high){
			if(i != RECEIVE_INDEX ) {  // it is invalid to suggest a reeive task (It's the transferee that takes initiatve)
				selected = i;
				high = priorities[sat_id][i];
			}
		}
	}
	if (selected != -1 &amp;&amp; high &gt; 0) {
		is_queued[selected] = true;
		sats[sat_id].suggested_task = selected;
	}
	else {
	sats[sat_id].suggested_task = -1;
	}
}
</declaration>
		<location id="id30" x="-216" y="-576">
			<committed/>
		</location>
		<location id="id31" x="-816" y="-576">
			<name x="-864" y="-584">Start</name>
		</location>
		<location id="id32" x="-720" y="-464">
			<name x="-768" y="-456">Slewing</name>
			<label kind="invariant" x="-816" y="-440">slew_time &lt;= 3</label>
		</location>
		<location id="id33" x="-216" y="-464">
			<name x="-256" y="-456">Checking</name>
			<committed/>
		</location>
		<location id="id34" x="-528" y="-464">
			<name x="-544" y="-448">Waiting</name>
			<label kind="invariant" x="-544" y="-432">loc_time &lt;= TASK_SUGGEST_INTERNAL</label>
		</location>
		<init ref="id31"/>
		<transition>
			<source ref="id32"/>
			<target ref="id34"/>
			<label kind="synchronisation" x="-672" y="-432">release[sat_id]?</label>
			<label kind="assignment" x="-672" y="-416">loc_time = 0</label>
			<nail x="-688" y="-416"/>
			<nail x="-576" y="-416"/>
		</transition>
		<transition>
			<source ref="id30"/>
			<target ref="id34"/>
			<label kind="guard" x="-504" y="-600">!validSuggestion(sat_id)</label>
			<nail x="-528" y="-576"/>
		</transition>
		<transition>
			<source ref="id30"/>
			<target ref="id34"/>
			<label kind="guard" x="-496" y="-576">validSuggestion(sat_id)</label>
			<label kind="synchronisation" x="-496" y="-552">add_task[sat_id]!</label>
			<nail x="-288" y="-552"/>
			<nail x="-512" y="-552"/>
		</transition>
		<transition>
			<source ref="id31"/>
			<target ref="id34"/>
			<label kind="synchronisation" x="-776" y="-600">start[sat_id]?</label>
			<label kind="assignment" x="-776" y="-576">loc_time = 0</label>
			<nail x="-552" y="-576"/>
		</transition>
		<transition>
			<source ref="id32"/>
			<target ref="id34"/>
			<label kind="guard" x="-672" y="-544">orientation(sat_id)</label>
			<label kind="synchronisation" x="-672" y="-528">slew_sat[sat_id]!</label>
			<label kind="assignment" x="-672" y="-504">loc_time = 0</label>
			<nail x="-688" y="-504"/>
			<nail x="-576" y="-504"/>
		</transition>
		<transition>
			<source ref="id32"/>
			<target ref="id32"/>
			<label kind="guard" x="-848" y="-536">slew_time &gt;= 3 &amp;&amp;
!orientation(sat_id)</label>
			<label kind="assignment" x="-848" y="-496">turn_satellite(),
slew_time = 0</label>
			<nail x="-856" y="-464"/>
			<nail x="-856" y="-496"/>
			<nail x="-736" y="-496"/>
		</transition>
		<transition>
			<source ref="id33"/>
			<target ref="id30"/>
			<label kind="assignment" x="-312" y="-536">loc_time = 0,
suggest_task()</label>
		</transition>
		<transition>
			<source ref="id34"/>
			<target ref="id33"/>
			<label kind="guard" x="-496" y="-488">loc_time &gt;= TASK_SUGGEST_INTERNAL</label>
			<label kind="assignment" x="-496" y="-464">RQ = sat_id</label>
		</transition>
		<transition>
			<source ref="id34"/>
			<target ref="id32"/>
			<label kind="synchronisation" x="-672" y="-480">slew_sat[sat_id]?</label>
			<label kind="assignment" x="-672" y="-464">slew_time = 0</label>
		</transition>
	</template>
	<template>
		<name>CheckRunnable</name>
		<declaration>bool all_checked = false;
int window_to_check = 0, task_to_check = 0;
int station = 0;
int index[STATIONS] = {0,0};
bool station_to_check = false;
bool can_run = false;

void inWindow(){
    if (TWINDOW[index[window_to_check]][window_to_check][2])
    {
        can_run = true;
    }else{
        can_run = false;
    }
}

void next() {
    if (task_to_check &lt; N) {
        if (window_to_check &lt; W-1) {
            window_to_check++;
        }
        else {
            task_to_check ++;
            window_to_check = 0;     
        }
    }
    else {
        all_checked = true;
        task_to_check = 0;
        window_to_check = 0;
    }
}


void resetRunnable() {
	int i;
	for (i = 0; i &lt; N; i++) {
		runnable[i] = 0;
	}
}


/** text */ 
bool independent(){ 
	int i = 0, count = 0;
	
	for (i = 0; i &lt; W; i++){
		if (!jobs[task_to_check].depend_win[i]) {
			count ++;
		}
		if (count == W) {
			return true;
		}
	}
	return false;
}

void allTaskChecked(){
	if (task_to_check +1 == N){
		all_checked = true;
		task_to_check = 0;
		window_to_check = 0;
	}
}

void skipWindowCheck() {
	runnable[task_to_check] = true;
	task_to_check += 1;
}

int windowEnd() {
	return TWINDOW[index[window_to_check]][window_to_check][1];
}

bool depends() {
	return jobs[task_to_check].depend_win[window_to_check];
}

//TODO overhold at vi ikke går ud over et vindue</declaration>
		<location id="id35" x="102" y="-212">
			<committed/>
		</location>
		<location id="id36" x="-306" y="-314">
			<name x="-316" y="-344">Wait</name>
		</location>
		<location id="id37" x="-119" y="-212">
			<committed/>
		</location>
		<location id="id38" x="-306" y="-212">
			<committed/>
		</location>
		<init ref="id36"/>
		<transition>
			<source ref="id35"/>
			<target ref="id38"/>
			<label kind="guard" x="-178" y="-67">!station_to_check &amp;&amp;
!can_run</label>
			<label kind="assignment" x="-178" y="-25">win_active[window_to_check] = can_run,
next()</label>
			<nail x="-8" y="-25"/>
			<nail x="-195" y="-25"/>
		</transition>
		<transition>
			<source ref="id35"/>
			<target ref="id38"/>
			<label kind="guard" x="-178" y="-178">can_run &amp;&amp; 
!station_to_check</label>
			<label kind="assignment" x="-178" y="-136">runnable[task_to_check] = true,
win_active[window_to_check] = can_run,
next()</label>
			<nail x="-8" y="-136"/>
			<nail x="-195" y="-136"/>
		</transition>
		<transition>
			<source ref="id35"/>
			<target ref="id35"/>
			<label kind="guard" x="127" y="-238">windowEnd() &lt; t_time - sats[RQ].offset</label>
			<label kind="assignment" x="280" y="-212">index[window_to_check]++</label>
			<nail x="450" y="-212"/>
			<nail x="450" y="-161"/>
		</transition>
		<transition>
			<source ref="id35"/>
			<target ref="id35"/>
			<label kind="guard" x="110" y="-144">windowEnd() &gt;= t_time - sats[RQ].offset &amp;&amp;
station_to_check</label>
			<label kind="assignment" x="102" y="-102">station_to_check = false,
inWindow()</label>
			<nail x="264" y="-102"/>
			<nail x="94" y="-102"/>
		</transition>
		<transition>
			<source ref="id37"/>
			<target ref="id35"/>
			<label kind="guard" x="-56" y="-240">depends()</label>
			<label kind="assignment" x="-102" y="-216">station_to_check = true,
can_run = false</label>
		</transition>
		<transition>
			<source ref="id38"/>
			<target ref="id38"/>
			<label kind="guard" x="-466" y="-172">independent()</label>
			<label kind="assignment" x="-466" y="-156">skipWindowCheck(),
allTaskChecked()</label>
			<nail x="-370" y="-196"/>
			<nail x="-346" y="-156"/>
		</transition>
		<transition>
			<source ref="id36"/>
			<target ref="id38"/>
			<label kind="synchronisation" x="-456" y="-264">check?</label>
			<label kind="assignment" x="-512" y="-280">resetRunnable()</label>
			<nail x="-399" y="-314"/>
			<nail x="-399" y="-212"/>
		</transition>
		<transition>
			<source ref="id37"/>
			<target ref="id38"/>
			<label kind="guard" x="-248" y="-280">!depends()</label>
			<label kind="assignment" x="-232" y="-256">next()</label>
			<nail x="-216" y="-264"/>
		</transition>
		<transition>
			<source ref="id38"/>
			<target ref="id37"/>
			<label kind="guard" x="-272" y="-229">!all_checked &amp;&amp;
!independent()</label>
		</transition>
		<transition>
			<source ref="id38"/>
			<target ref="id36"/>
			<label kind="guard" x="-392" y="-296">all_checked</label>
			<label kind="synchronisation" x="-392" y="-264">check!</label>
			<label kind="assignment" x="-392" y="-280">all_checked = false</label>
		</transition>
	</template>
	<system>
system OrbitTimer, CheckRunnable, Scheduler &lt; Satellite &lt; Processor ;</system>
	<queries>
		<query>
			<formula>E&lt;&gt; Processor(2).Occupied &amp;&amp; Processor(2).price == 0 &amp;&amp; Processor(2).task == 0 &amp;&amp; t_time &lt; 400
			</formula>
			<comment>
			</comment>
		</query>
		<query>
			<formula>E&lt;&gt; t_time &gt; 600
			</formula>
			<comment>
			</comment>
		</query>
	</queries>
</nta>
